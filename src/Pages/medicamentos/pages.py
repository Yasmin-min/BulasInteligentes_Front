import streamlit as st
import requests
from utils.st import rename

API_URL = "#url aqui"  # üîπ Substitua pela URL real da sua API, ex: http://localhost:8000/medicamentos


# ---- Fun√ß√µes auxiliares ----
@st.cache_data(ttl=30)
def _carregar_medicamentos():
    """Busca lista de medicamentos na API (com cache)."""
    try:
        response = requests.get(API_URL, timeout=10)
        response.raise_for_status()
        data = response.json()

        # Garante formato esperado
        if isinstance(data, list):
            return data
        elif isinstance(data, dict) and "items" in data:
            return data["items"]
        else:
            st.warning("Formato inesperado retornado pela API.")
            return []
    except requests.exceptions.RequestException as e:
        st.error(f"Erro ao conectar √† API: {e}")
        return []


def _get_meds():
    """Mant√©m medicamentos em sess√£o para sele√ß√£o local."""
    if "MEDICAMENTOS" not in st.session_state:
        st.session_state["MEDICAMENTOS"] = _carregar_medicamentos()
    return st.session_state["MEDICAMENTOS"]


def _filtrar_busca(query: str):
    meds = _get_meds()
    if not query:
        return meds
    q = query.lower().strip()
    return [m for m in meds if q in m.get("nome", "").lower() or q in m.get("indica√ß√µes", "").lower()]


def _mostrar_detalhes(med):
    st.subheader(med["nome"])
    cols = st.columns([1, 1, 1])
    with cols[0]:
        st.markdown(f"**Fabricante:** {med.get('fabricante', '-')}")
    with cols[1]:
        st.markdown(f"**Indica√ß√µes:** {med.get('indica√ß√µes', '-')}")
    with cols[2]:
        st.markdown(f"**Contraindica√ß√µes:** {med.get('contraindica√ß√µes', '-')}")

    st.markdown("---")
    st.markdown(f"**Posologia:** {med.get('posologia', '-')}")
    efeitos = med.get("efeitos_colaterais", [])
    if isinstance(efeitos, list):
        st.markdown("**Efeitos colaterais:** " + ", ".join(efeitos))
    else:
        st.markdown(f"**Efeitos colaterais:** {efeitos}")


def _adicionar_medicamento():
    """Formul√°rio para adicionar novo medicamento via API."""
    with st.expander("‚ûï Adicionar novo medicamento"):
        with st.form("form_novo_medicamento", clear_on_submit=True):
            nome = st.text_input("Nome do medicamento")
            fabricante = st.text_input("Fabricante")
            indicacoes = st.text_area("Indica√ß√µes")
            posologia = st.text_area("Posologia")
            efeitos = st.text_area("Efeitos colaterais (separe por v√≠rgula)")
            contra = st.text_area("Contraindica√ß√µes")
            submitted = st.form_submit_button("Salvar medicamento")

            if submitted:
                if not nome:
                    st.error("O nome do medicamento √© obrigat√≥rio.")
                else:
                    payload = {
                        "nome": nome.strip(),
                        "fabricante": fabricante.strip() or "Desconhecido",
                        "indica√ß√µes": indicacoes.strip(),
                        "posologia": posologia.strip(),
                        "efeitos_colaterais": [e.strip() for e in efeitos.split(",") if e.strip()],
                        "contraindica√ß√µes": contra.strip(),
                    }

                    try:
                        r = requests.post(API_URL, json=payload, timeout=10)
                        r.raise_for_status()
                        st.success(f"Medicamento **{nome}** adicionado com sucesso!")
                        _carregar_medicamentos.clear()  # limpa cache
                        st.session_state["MEDICAMENTOS"] = _carregar_medicamentos()
                    except requests.exceptions.RequestException as e:
                        st.error(f"Erro ao salvar medicamento: {e}")


# ---- P√°gina principal ----
@rename("Medicamentos")
def Main():
    st.title("Medicamentos üíä")

    # Seletor e busca
    sel_key = "med_selecionado"
    st.session_state.setdefault(sel_key, None)

    # üîπ Bot√£o para adicionar novo medicamento
    _adicionar_medicamento()

    # üîç Campo de busca
    query = st.text_input("Buscar medicamento (nome/indica√ß√£o):", placeholder="ex.: dor, febre, amoxi...")
    lista = _filtrar_busca(query)

    # üßæ Lista de bot√µes
    st.markdown("### Lista de medicamentos")
    cols_per_row = 3
    for i in range(0, len(lista), cols_per_row):
        cols = st.columns(cols_per_row)
        for j, col in enumerate(cols):
            idx = i + j
            if idx < len(lista):
                med = lista[idx]
                with col:
                    if st.button(med["nome"], key=f"btn_{med['nome']}"):
                        st.session_state[sel_key] = med["nome"]

    # üìã Exibe detalhes do selecionado
    st.markdown("---")
    if st.session_state[sel_key]:
        med = next((m for m in _get_meds() if m["nome"] == st.session_state[sel_key]), None)
        if med:
            _mostrar_detalhes(med)
    else:
        st.info("Selecione um medicamento para ver detalhes.")
